<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>成语接龙 LLM 对战平台</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
    background: #f5f7fa; color: #333; line-height: 1.6;
  }
  .container { max-width: 960px; margin: 0 auto; padding: 24px 16px; }
  h1 { text-align: center; margin-bottom: 24px; font-size: 1.6rem; }

  /* 配置区 */
  .config-section {
    background: #fff; border-radius: 12px; padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
  }
  .config-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  }
  .config-group h3 { margin-bottom: 8px; font-size: 0.95rem; color: #555; }
  .config-group label { display: block; font-size: 0.8rem; color: #888; margin: 6px 0 2px; }
  .config-group input {
    width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;
    font-size: 0.9rem; outline: none; transition: border-color 0.2s;
  }
  .config-group input:focus { border-color: #4a90d9; }
  .start-row {
    display: flex; gap: 12px; align-items: end; margin-top: 16px;
  }
  .start-row .field { flex: 1; }
  .start-row label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 2px; }
  .start-row input {
    width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;
    font-size: 0.9rem; outline: none;
  }
  #btn-start {
    padding: 8px 28px; background: #4a90d9; color: #fff; border: none;
    border-radius: 6px; font-size: 0.95rem; cursor: pointer; white-space: nowrap;
  }
  #btn-start:hover { background: #3a7bc8; }
  #btn-start:disabled { background: #aaa; cursor: not-allowed; }

  /* System Prompt 折叠区 */
  .prompt-section { margin-top: 16px; }
  .prompt-toggle {
    display: inline-flex; align-items: center; gap: 6px;
    background: none; border: none; color: #4a90d9; font-size: 0.88rem;
    cursor: pointer; padding: 0;
  }
  .prompt-toggle:hover { text-decoration: underline; }
  .prompt-toggle .arrow { transition: transform 0.2s; display: inline-block; }
  .prompt-toggle .arrow.open { transform: rotate(90deg); }
  .prompt-body { display: none; margin-top: 8px; }
  .prompt-body.open { display: block; }
  .prompt-body textarea {
    width: 100%; min-height: 180px; padding: 10px; border: 1px solid #ddd;
    border-radius: 6px; font-size: 0.88rem; line-height: 1.5; resize: vertical;
    font-family: inherit; outline: none; transition: border-color 0.2s;
  }
  .prompt-body textarea:focus { border-color: #4a90d9; }
  .prompt-reset {
    margin-top: 6px; background: none; border: 1px solid #ddd; color: #888;
    padding: 4px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
  }
  .prompt-reset:hover { border-color: #999; color: #555; }

  /* 对战区 */
  .battle-section {
    background: #fff; border-radius: 12px; padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
    min-height: 120px; display: none;
  }
  .battle-section h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .battle-area {
    max-height: 500px; overflow-y: auto; padding: 8px 0;
  }
  .round-item {
    display: flex; margin-bottom: 10px; align-items: flex-start;
  }
  .round-item.player-a { justify-content: flex-start; }
  .round-item.player-b { justify-content: flex-end; }
  .bubble {
    max-width: 70%; padding: 10px 14px; border-radius: 12px;
    position: relative; font-size: 0.95rem;
  }
  .player-a .bubble { background: #e8f4fd; border-bottom-left-radius: 4px; }
  .player-b .bubble { background: #f0f8e8; border-bottom-right-radius: 4px; }
  .bubble.invalid { background: #fde8e8; border: 1px solid #e88; }
  .bubble .meta {
    font-size: 0.75rem; color: #999; margin-bottom: 4px;
  }
  .bubble .word { font-size: 1.3rem; font-weight: 600; }
  .bubble .error-msg { font-size: 0.8rem; color: #c33; margin-top: 4px; }
  .bubble .next-word { font-size: 0.75rem; color: #999; margin-top: 4px; }

  /* 结果区 */
  .result-section {
    background: #fff; border-radius: 12px; padding: 20px; text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
    display: none;
  }
  .result-section .winner { font-size: 1.4rem; font-weight: 700; margin-bottom: 8px; }
  .result-section .detail { font-size: 0.9rem; color: #666; }

  /* 历史区 */
  .history-section {
    background: #fff; border-radius: 12px; padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .history-section h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .history-list { list-style: none; }
  .history-list li {
    padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
    transition: background 0.15s;
  }
  .history-list li:hover { background: #f8f9fa; }
  .history-list li:last-child { border-bottom: none; }
  .history-list .info { font-size: 0.9rem; }
  .history-list .info .models { font-weight: 500; }
  .history-list .result-tag {
    font-size: 0.8rem; padding: 2px 8px; border-radius: 4px;
    font-weight: 500;
  }
  .result-tag.winner-a { background: #e8f4fd; color: #2a6faa; }
  .result-tag.winner-b { background: #f0f8e8; color: #4a8a2a; }
  .result-tag.draw { background: #f5f0e0; color: #8a7a2a; }
  .empty-msg { color: #aaa; font-size: 0.9rem; text-align: center; padding: 20px; }

  /* 详情弹窗 */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); display: none; justify-content: center;
    align-items: center; z-index: 100;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #fff; border-radius: 12px; padding: 24px;
    max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;
  }
  .modal h3 { margin-bottom: 12px; }
  .modal .close-btn {
    float: right; background: none; border: none; font-size: 1.3rem;
    cursor: pointer; color: #999;
  }
  .modal .close-btn:hover { color: #333; }

  /* 分割线 */
  .divider {
    border: none; border-top: 2px solid #e0e0e0; margin: 32px 0;
  }

  /* Benchmark 区 */
  .bench-section {
    background: #fff; border-radius: 12px; padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
  }
  .bench-section h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .bench-params {
    display: flex; gap: 12px; align-items: end; margin-top: 12px;
  }
  .bench-params .field { flex: 1; }
  .bench-params .field label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 2px; }
  .bench-params .field input {
    width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;
    font-size: 0.9rem; outline: none;
  }
  .bench-params .field input:focus { border-color: #4a90d9; }
  #btn-bench {
    padding: 8px 28px; background: #e67e22; color: #fff; border: none;
    border-radius: 6px; font-size: 0.95rem; cursor: pointer; white-space: nowrap;
  }
  #btn-bench:hover { background: #cf6d17; }
  #btn-bench:disabled { background: #aaa; cursor: not-allowed; }

  /* 进度条 */
  .progress-wrap {
    margin: 16px 0; display: none;
  }
  .progress-bar-outer {
    background: #eee; border-radius: 8px; height: 24px; overflow: hidden; position: relative;
  }
  .progress-bar-inner {
    background: linear-gradient(90deg, #4a90d9, #67b26f); height: 100%; width: 0%;
    border-radius: 8px; transition: width 0.3s;
  }
  .progress-text {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem; font-weight: 600; color: #333;
  }

  /* Benchmark 结果表 */
  .bench-table {
    width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.88rem;
  }
  .bench-table th, .bench-table td {
    padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;
  }
  .bench-table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 0.8rem; }
  .bench-table td.win-a { color: #2a6faa; font-weight: 600; }
  .bench-table td.win-b { color: #4a8a2a; font-weight: 600; }
  .bench-table td.draw-cell { color: #8a7a2a; font-weight: 600; }

  /* 统计卡片 */
  .bench-summary {
    display: none; margin-top: 16px;
  }
  .summary-cards {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;
  }
  .summary-card {
    background: #f8f9fa; border-radius: 8px; padding: 16px; text-align: center;
  }
  .summary-card .num { font-size: 1.8rem; font-weight: 700; }
  .summary-card .label { font-size: 0.8rem; color: #888; margin-top: 4px; }
  .summary-card.card-a .num { color: #2a6faa; }
  .summary-card.card-b .num { color: #4a8a2a; }
  .summary-card.card-draw .num { color: #8a7a2a; }

  .breakdown-table {
    width: 100%; border-collapse: collapse; font-size: 0.88rem; margin-top: 8px;
  }
  .breakdown-table th, .breakdown-table td {
    padding: 6px 10px; border-bottom: 1px solid #eee; text-align: center;
  }
  .breakdown-table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 0.8rem; }
</style>
</head>
<body>
<div class="container">
  <h1>成语接龙 LLM 对战平台</h1>

  <!-- 配置区 -->
  <div class="config-section">
    <div class="config-grid">
      <div class="config-group">
        <h3>模型 A</h3>
        <label>Base URL</label>
        <input id="a-url" type="text" placeholder="https://api.example.com/v1">
        <label>API Key</label>
        <input id="a-key" type="password" placeholder="sk-xxx">
        <label>模型名称</label>
        <input id="a-model" type="text" placeholder="gpt-4o">
      </div>
      <div class="config-group">
        <h3>模型 B</h3>
        <label>Base URL</label>
        <input id="b-url" type="text" placeholder="https://api.example.com/v1">
        <label>API Key</label>
        <input id="b-key" type="password" placeholder="sk-xxx">
        <label>模型名称</label>
        <input id="b-model" type="text" placeholder="claude-sonnet-4-20250514">
      </div>
    </div>
    <div class="start-row">
      <div class="field">
        <label>起始成语</label>
        <input id="start-word" type="text" placeholder="一心一意">
      </div>
      <button id="btn-start">开始对战</button>
    </div>
    <div class="prompt-section">
      <button class="prompt-toggle" id="prompt-toggle" type="button">
        <span class="arrow" id="prompt-arrow">&#9654;</span>
        系统提示词配置
      </button>
      <div class="prompt-body" id="prompt-body">
        <textarea id="system-prompt" placeholder="加载中..."></textarea>
        <button class="prompt-reset" id="prompt-reset" type="button">恢复默认</button>
      </div>
    </div>
  </div>

  <!-- 对战区 -->
  <div class="battle-section" id="battle-section">
    <h2>对战进行中...</h2>
    <div class="battle-area" id="battle-area"></div>
  </div>

  <!-- 结果区 -->
  <div class="result-section" id="result-section"></div>

  <hr class="divider">

  <!-- Benchmark 配置区 -->
  <div class="bench-section">
    <h2>批量测试（Benchmark）</h2>
    <p style="font-size:0.85rem;color:#888;margin-bottom:8px">随机抽取成语，每个成语交叉测试（A先手 + B先手），统计双方胜率。模型配置复用上方设置。</p>
    <div class="bench-params">
      <div class="field">
        <label>起始成语数量</label>
        <input id="bench-num" type="number" value="5" min="1" max="50">
      </div>
      <div class="field">
        <label>最大并发数</label>
        <input id="bench-concurrency" type="number" value="3" min="1" max="10">
      </div>
      <button id="btn-bench">开始测试</button>
    </div>
  </div>

  <!-- Benchmark 进度区 -->
  <div class="bench-section progress-wrap" id="bench-progress-section">
    <h2>测试进度</h2>
    <div class="progress-bar-outer">
      <div class="progress-bar-inner" id="bench-bar"></div>
      <div class="progress-text" id="bench-progress-text">0 / 0</div>
    </div>
    <table class="bench-table" id="bench-table">
      <thead>
        <tr>
          <th>起始成语</th>
          <th>先手</th>
          <th>胜者</th>
          <th>原因</th>
          <th>回合数</th>
          <th>详情</th>
        </tr>
      </thead>
      <tbody id="bench-tbody"></tbody>
    </table>
  </div>

  <!-- Benchmark 统计区 -->
  <div class="bench-section bench-summary" id="bench-summary">
    <h2>测试结果</h2>
    <div class="summary-cards" id="summary-cards"></div>
    <h3 style="font-size:0.95rem;margin-bottom:4px">先后手胜率交叉表</h3>
    <table class="breakdown-table">
      <thead>
        <tr><th></th><th>先手胜</th><th>后手胜</th><th>平</th></tr>
      </thead>
      <tbody id="breakdown-tbody"></tbody>
    </table>
    <div id="first-mover-conclusion" style="margin-top:10px;padding:10px 14px;border-radius:8px;font-size:0.9rem;"></div>
  </div>

  <!-- 历史区 -->
  <div class="history-section">
    <h2>历史对战</h2>
    <ul class="history-list" id="history-list"></ul>
  </div>
</div>

<!-- 详情弹窗 -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>

<script>
const $ = id => document.getElementById(id);

// ========== System Prompt ==========
let defaultSystemPrompt = '';

async function loadDefaultPrompt() {
  try {
    const res = await fetch('/default-system-prompt');
    const data = await res.json();
    defaultSystemPrompt = data.system_prompt;
    $('system-prompt').value = defaultSystemPrompt;
  } catch {
    $('system-prompt').placeholder = '加载默认提示词失败';
  }
}

$('prompt-toggle').addEventListener('click', () => {
  const body = $('prompt-body');
  const arrow = $('prompt-arrow');
  const open = body.classList.toggle('open');
  arrow.classList.toggle('open', open);
});

$('prompt-reset').addEventListener('click', () => {
  $('system-prompt').value = defaultSystemPrompt;
});

loadDefaultPrompt();

// 加载历史记录
async function loadHistory() {
  const list = $('history-list');
  try {
    const res = await fetch('/battles');
    const data = await res.json();
    if (!data.length) {
      list.innerHTML = '<li class="empty-msg">暂无对战记录</li>';
      return;
    }
    list.innerHTML = data.map(b => {
      const tagClass = b.winner === 'draw' ? 'draw' : b.winner === 'A' ? 'winner-a' : 'winner-b';
      const tagText = b.winner === 'draw' ? '平局' : `模型${b.winner}胜`;
      const time = new Date(b.created_at).toLocaleString('zh-CN');
      return `<li onclick="showDetail(${b.id})">
        <span class="info">
          <span class="models">${esc(b.model_a_name)} vs ${esc(b.model_b_name)}</span>
          &nbsp;·&nbsp;${esc(b.start_word)}&nbsp;·&nbsp;<span style="color:#aaa">${time}</span>
        </span>
        <span class="result-tag ${tagClass}">${tagText} — ${esc(b.reason)}</span>
      </li>`;
    }).join('');
  } catch {
    list.innerHTML = '<li class="empty-msg">加载失败</li>';
  }
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// 显示详情
async function showDetail(id) {
  const overlay = $('modal-overlay');
  const content = $('modal-content');
  try {
    const res = await fetch(`/battles/${id}`);
    if (!res.ok) throw new Error();
    const b = await res.json();
    const winText = b.winner === 'draw' ? '平局' : `模型${b.winner}胜`;
    let html = `<button class="close-btn" onclick="closeModal()">&times;</button>`;
    html += `<h3>${esc(b.model_a_name)} vs ${esc(b.model_b_name)}</h3>`;
    html += `<p style="color:#666;margin-bottom:12px">起始：${esc(b.start_word)} · ${winText} · ${esc(b.reason)}</p>`;
    html += `<div>`;
    for (const r of b.history) {
      const side = r.player === 'A' ? 'player-a' : 'player-b';
      const cls = r.valid ? '' : ' invalid';
      html += `<div class="round-item ${side}">
        <div class="bubble${cls}">
          <div class="meta">第${r.round}回合 · ${esc(r.model)} (${r.player})</div>
          <div class="word">${esc(r.word)}</div>
          ${r.next_word ? `<div class="next-word">预备：${esc(r.next_word)}</div>` : ''}
          ${!r.valid && r.message ? `<div class="error-msg">${esc(r.message)}</div>` : ''}
        </div>
      </div>`;
    }
    html += `</div>`;
    content.innerHTML = html;
    overlay.classList.add('active');
  } catch {
    alert('加载详情失败');
  }
}

function closeModal() {
  $('modal-overlay').classList.remove('active');
}
$('modal-overlay').addEventListener('click', e => {
  if (e.target === $('modal-overlay')) closeModal();
});

// 开始对战
$('btn-start').addEventListener('click', async () => {
  const btn = $('btn-start');
  const battleSection = $('battle-section');
  const battleArea = $('battle-area');
  const resultSection = $('result-section');

  // 收集配置
  const systemPrompt = $('system-prompt').value.trim();
  const body = {
    model_a: { base_url: $('a-url').value.trim(), api_key: $('a-key').value.trim(), model: $('a-model').value.trim() },
    model_b: { base_url: $('b-url').value.trim(), api_key: $('b-key').value.trim(), model: $('b-model').value.trim() },
    start_word: $('start-word').value.trim(),
    system_prompt: systemPrompt
  };

  if (!body.model_a.base_url || !body.model_a.api_key || !body.model_a.model ||
      !body.model_b.base_url || !body.model_b.api_key || !body.model_b.model ||
      !body.start_word) {
    alert('请填写完整配置');
    return;
  }

  btn.disabled = true;
  battleSection.style.display = 'block';
  battleSection.querySelector('h2').textContent = '对战进行中...';
  battleArea.innerHTML = '';
  resultSection.style.display = 'none';

  // 添加起始成语
  battleArea.innerHTML = `<div style="text-align:center;color:#888;margin:8px 0;font-size:0.9rem">起始成语：<strong>${esc(body.start_word)}</strong></div>`;

  try {
    const res = await fetch('/battle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert(err.detail || '请求失败');
      btn.disabled = false;
      return;
    }

    // 手动解析 SSE（POST 不能用 EventSource）
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true }).replace(/\r\n/g, '\n');

      // 按双换行分割 SSE 事件
      const parts = buffer.split('\n\n');
      buffer = parts.pop(); // 保留不完整部分

      for (const part of parts) {
        let eventType = 'message';
        let data = '';
        for (const line of part.split('\n')) {
          if (line.startsWith('event:')) eventType = line.slice(6).trim();
          else if (line.startsWith('data:')) data = line.slice(5).trim();
        }
        if (!data) continue;

        const parsed = JSON.parse(data);

        if (eventType === 'round') {
          const side = parsed.player === 'A' ? 'player-a' : 'player-b';
          const cls = parsed.valid ? '' : ' invalid';
          const el = document.createElement('div');
          el.className = `round-item ${side}`;
          el.innerHTML = `<div class="bubble${cls}">
            <div class="meta">第${parsed.round}回合 · ${esc(parsed.model)} (${parsed.player})</div>
            <div class="word">${esc(parsed.word)}</div>
            ${parsed.next_word ? `<div class="next-word">预备：${esc(parsed.next_word)}</div>` : ''}
            ${!parsed.valid && parsed.message ? `<div class="error-msg">${esc(parsed.message)}</div>` : ''}
            ${!parsed.success ? `<div class="error-msg">认输</div>` : ''}
          </div>`;
          battleArea.appendChild(el);
          battleArea.scrollTop = battleArea.scrollHeight;
        } else if (eventType === 'result') {
          battleSection.querySelector('h2').textContent = '对战结束';
          const winText = parsed.winner === 'draw' ? '平局！' :
            `模型${parsed.winner}获胜！`;
          resultSection.style.display = 'block';
          resultSection.innerHTML = `
            <div class="winner">${winText}</div>
            <div class="detail">${esc(parsed.reason)} · 共 ${parsed.rounds} 回合</div>
          `;
          loadHistory();
        }
      }
    }
  } catch (e) {
    alert('对战过程中出错: ' + e.message);
  } finally {
    btn.disabled = false;
  }
});

// ========== Benchmark ==========
$('btn-bench').addEventListener('click', async () => {
  const btn = $('btn-bench');
  const progressSection = $('bench-progress-section');
  const summarySection = $('bench-summary');
  const bar = $('bench-bar');
  const progressText = $('bench-progress-text');
  const tbody = $('bench-tbody');

  // 复用上方模型配置
  const benchSystemPrompt = $('system-prompt').value.trim();
  const body = {
    model_a: { base_url: $('a-url').value.trim(), api_key: $('a-key').value.trim(), model: $('a-model').value.trim() },
    model_b: { base_url: $('b-url').value.trim(), api_key: $('b-key').value.trim(), model: $('b-model').value.trim() },
    num_words: parseInt($('bench-num').value) || 5,
    max_concurrency: parseInt($('bench-concurrency').value) || 3,
    system_prompt: benchSystemPrompt
  };

  if (!body.model_a.base_url || !body.model_a.api_key || !body.model_a.model ||
      !body.model_b.base_url || !body.model_b.api_key || !body.model_b.model) {
    alert('请先在上方填写完整的模型配置');
    return;
  }

  btn.disabled = true;
  progressSection.style.display = 'block';
  summarySection.style.display = 'none';
  tbody.innerHTML = '';
  bar.style.width = '0%';
  progressText.textContent = '0 / 0';

  try {
    const res = await fetch('/benchmark', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert(err.detail || '请求失败');
      btn.disabled = false;
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true }).replace(/\r\n/g, '\n');

      const parts = buffer.split('\n\n');
      buffer = parts.pop();

      for (const part of parts) {
        let eventType = 'message';
        let data = '';
        for (const line of part.split('\n')) {
          if (line.startsWith('event:')) eventType = line.slice(6).trim();
          else if (line.startsWith('data:')) data = line.slice(5).trim();
        }
        if (!data) continue;
        const parsed = JSON.parse(data);

        if (eventType === 'progress') {
          const pct = Math.round((parsed.completed / parsed.total) * 100);
          bar.style.width = pct + '%';
          progressText.textContent = `${parsed.completed} / ${parsed.total}`;

          const r = parsed.current_result;
          const winCls = r.winner === 'A' ? 'win-a' : r.winner === 'B' ? 'win-b' : 'draw-cell';
          const winText = r.winner === 'draw' ? '平局' : `模型${r.winner}`;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${esc(r.start_word)}</td>
            <td>模型${r.first_player}</td>
            <td class="${winCls}">${winText}</td>
            <td>${esc(r.reason)}</td>
            <td>${r.rounds}</td>
            <td><a href="javascript:void(0)" onclick="showDetail(${r.battle_id})" style="color:#4a90d9">查看</a></td>
          `;
          tbody.appendChild(row);
        } else if (eventType === 'summary') {
          renderBenchSummary(parsed);
          loadHistory();
        }
      }
    }
  } catch (e) {
    alert('测试过程中出错: ' + e.message);
  } finally {
    btn.disabled = false;
  }
});

function renderBenchSummary(s) {
  const section = $('bench-summary');
  section.style.display = 'block';

  const aRate = (s.model_a_win_rate * 100).toFixed(1);
  const bRate = (s.model_b_win_rate * 100).toFixed(1);

  $('summary-cards').innerHTML = `
    <div class="summary-card card-a">
      <div class="num">${s.model_a_wins}胜 <span style="font-size:0.9rem">(${aRate}%)</span></div>
      <div class="label">${esc(s.model_a_name)}</div>
    </div>
    <div class="summary-card card-draw">
      <div class="num">${s.draws}</div>
      <div class="label">平局</div>
    </div>
    <div class="summary-card card-b">
      <div class="num">${s.model_b_wins}胜 <span style="font-size:0.9rem">(${bRate}%)</span></div>
      <div class="label">${esc(s.model_b_name)}</div>
    </div>
  `;

  // 交叉表：每行是"谁先手"，列是"先手胜 / 后手胜 / 平"
  const aFirstTotal = s.model_a_first_wins + s.model_a_first_losses + s.model_a_first_draws;
  const bFirstTotal = s.model_b_first_wins + s.model_b_first_losses + s.model_b_first_draws;
  const totalAll = aFirstTotal + bFirstTotal;

  // A先手时: 先手胜=A赢, 后手胜=B赢
  const aFirst_firstWin = s.model_a_first_wins;
  const aFirst_secondWin = s.model_a_first_losses;
  const aFirst_draw = s.model_a_first_draws;
  // B先手时: 先手胜=B赢, 后手胜=A赢
  const bFirst_firstWin = s.model_b_first_wins;
  const bFirst_secondWin = s.model_b_first_losses;
  const bFirst_draw = s.model_b_first_draws;
  // 汇总
  const totalFirstWin = aFirst_firstWin + bFirst_firstWin;
  const totalSecondWin = aFirst_secondWin + bFirst_secondWin;
  const totalDraw = aFirst_draw + bFirst_draw;

  const pct = (n, t) => t > 0 ? (n / t * 100).toFixed(1) + '%' : '-';

  $('breakdown-tbody').innerHTML = `
    <tr>
      <td>${esc(s.model_a_name)} 先手</td>
      <td>${aFirst_firstWin} <span style="color:#999;font-size:0.8rem">(${pct(aFirst_firstWin, aFirstTotal)})</span></td>
      <td>${aFirst_secondWin} <span style="color:#999;font-size:0.8rem">(${pct(aFirst_secondWin, aFirstTotal)})</span></td>
      <td>${aFirst_draw}</td>
    </tr>
    <tr>
      <td>${esc(s.model_b_name)} 先手</td>
      <td>${bFirst_firstWin} <span style="color:#999;font-size:0.8rem">(${pct(bFirst_firstWin, bFirstTotal)})</span></td>
      <td>${bFirst_secondWin} <span style="color:#999;font-size:0.8rem">(${pct(bFirst_secondWin, bFirstTotal)})</span></td>
      <td>${bFirst_draw}</td>
    </tr>
    <tr style="font-weight:700;border-top:2px solid #ccc">
      <td>总计</td>
      <td>${totalFirstWin} <span style="color:#999;font-size:0.8rem">(${pct(totalFirstWin, totalAll)})</span></td>
      <td>${totalSecondWin} <span style="color:#999;font-size:0.8rem">(${pct(totalSecondWin, totalAll)})</span></td>
      <td>${totalDraw}</td>
    </tr>
  `;

  // 结论
  const conc = $('first-mover-conclusion');
  if (totalFirstWin > totalSecondWin) {
    conc.style.background = '#e8f4fd';
    conc.innerHTML = `<strong>结论：先手优势明显</strong> — 先手胜率 ${pct(totalFirstWin, totalAll)}，后手胜率 ${pct(totalSecondWin, totalAll)}`;
  } else if (totalSecondWin > totalFirstWin) {
    conc.style.background = '#f0f8e8';
    conc.innerHTML = `<strong>结论：后手优势明显</strong> — 后手胜率 ${pct(totalSecondWin, totalAll)}，先手胜率 ${pct(totalFirstWin, totalAll)}`;
  } else {
    conc.style.background = '#f5f0e0';
    conc.innerHTML = `<strong>结论：先后手无明显差异</strong> — 先手胜率 ${pct(totalFirstWin, totalAll)}，后手胜率 ${pct(totalSecondWin, totalAll)}`;
  }
}

// 初始加载
loadHistory();
</script>
</body>
</html>
